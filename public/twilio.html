<html>
<head>
	<title>Twilio API</title>
</head>
<body>
<div class="row">
	<div class="col-md-12">
		<form id="contactform" role="form" action="#" method="POST">
		                <div class="form-group">
		                    <h3>Call Me</h3>

		                    <p class="help-block">
		                        No need to go through any more resumes. Click to interview me right now:
		                    </p>
		                </div>
		                <div class="form-group">
		                    <input class="form-control" type="text" name="phone" id="phoneNumber"
		                           placeholder="(651) 555-7889">
		                </div>
		    <button type="submit" class="btn btn-default">Call Me</button>
		</form> 
	</div>
</div>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

		<script>
			$form.on('submit', function(e) {
		        // Prevent form submission and repeat clicks
		        e.preventDefault();
		        $submit.attr('disabled', 'disabled');

		        // Submit the form via ajax
		        $.ajax({
		            url:'/call',
		            method:'POST',
		            data: $form.serialize()
		        }).done(function(data) {
		            content = JSON.parse(data);
		            alert(content.message);
		        }).fail(function() {
		            alert('There was a problem calling you - please try again later.');
		        }).always(function() {
		            $submit.removeAttr('disabled');
		        });

		    });


		    String phoneNumber = request.getParameter("phone");

		    if (phoneNumber != null) {
		      if (this.appSetup == null || this.client == null) {
		        appSetup = new AppSetup();
		        client = null;
		        try {
		          client = new TwilioRestClient(appSetup.getAccountSid(), appSetup.getAuthToken());
		        } catch (UndefinedEnvironmentVariableException e) {
		          response.getOutputStream().write(getJSONResponse(e.getMessage()).getBytes());
		          return;
		        }
		      }

		      Map<String, String> params = new HashMap<>();
		      String twilioNumber;
		      try {
		        twilioNumber = appSetup.getTwilioNumber();
		      } catch (UndefinedEnvironmentVariableException e) {
		        response.getOutputStream().write(getJSONResponse(e.getMessage()).getBytes());
		        return;
		      }

		      // Full path to the end point that will respond with the call TwiML
		      String path =
		          request.getRequestURL().toString().replace(request.getRequestURI(), "") + "/connect";
		      params.put("From", twilioNumber);
		      params.put("To", phoneNumber);
		      params.put("Url", path);

		      try {
		        client.getAccount().getCallFactory().create(params);
		      } catch (TwilioRestException e) {
		        String message = "Twilio rest client error: " + e.getErrorMessage() +
		            "\nRemember not to use localhost to access this app, use your ngrok URL";
		        response.getOutputStream().write(getJSONResponse(message).getBytes());
		        return;
		      }

					      private boolean isValidRequest(HttpServletRequest request) {
			    if (this.validator == null) {
			      try {
			        validator = new TwilioUtils(appSetup.getAuthToken());
			      } catch (UndefinedEnvironmentVariableException e) {
			        e.printStackTrace();
			        return false;
			      }
			    }

			    String url = request.getRequestURL().toString();
			    Map<String, String> params = new HashMap<>();

			    Enumeration<String> names = request.getParameterNames();
			    while (names.hasMoreElements()) {
			      String currentName = names.nextElement();
			      params.put(currentName, request.getParameter(currentName));
			    }

			    String signature = request.getHeader("X-Twilio-Signature");

			    return validator.validateRequest(signature, url, params);
			  }
			}
					private String getXMLResponse() {
		    TwiMLResponse twimlResponse = new TwiMLResponse();

		    Say sayMessage = new Say(
		        "If this were a real click to call implementation, you would be connected to an agent at this point.");
		    Hangup hangup = new Hangup();

		    try {
		      twimlResponse.append(sayMessage);
		      twimlResponse.append(hangup);
		    } catch (TwiMLException e) {
		      System.out.println("Twilio's response building error");
		    }

		    return twimlResponse.toXML();
		  }
		</script>
</body>
</html>