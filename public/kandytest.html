<html><head>
    <title>Kandy | Anonymous Call</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta name="csrf-param" content="authenticity_token">
    <meta name="csrf-token" content="pcdQ4QeomyYN+zg0KWSFHERiJFFkGYhMuRCTWxJ621/FG0b+OnTqb8W0rCVmqAvUN2WRKhrwpKAdx26J7CP2FA==">
    <link rel="shortcut icon" type="image/x-icon" href="http://dev.kandy.io:3000/assets/favicon-3da99d2536c9fa570157780f5d5f6f0d.ico">
    <!--Load Bootstrap CSS (optional)-->
    <link rel="stylesheet" media="screen" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <link rel="stylesheet" media="screen" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
    <!--Load Kandy JS files -->
    <script src="https://code.jquery.com/jquery-1.7.2.min.js"></script>
    <script src="https://kandy-portal.s3.amazonaws.com/public/javascript/kandy/2.3.0/kandy.js"></script>
    <!--Load Pace AJAX Progress Bar (optional)-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script>
    <link rel="stylesheet" media="screen" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/themes/pink/pace-theme-minimal.css">


    <style>
   #incoming-video {
        background-color: #000;
        background-size: contain;
        height: 300px;
    }
    </style>
</head>

<body class=" pace-done"><div class="pace  pace-inactive"><div class="pace-progress" data-progress-text="100%" data-progress="99" style="transform: translate3d(100%, 0px, 0px);">
  <div class="pace-progress-inner"></div>
</div>
<div class="pace-activity"></div></div>
    <div class="container">
        <div class="row">
            <div class="col-xs-8 col-xs-offset-2">
                <div id="app-details">
                    <h1 class="h2">
              Anonymous Call
            </h1>
                    <p>
                        This application demonstrates Anonymous Call
                    </p>
                </div>
                <hr>
                <div id="login-form">
                    <form id="login-form" class="simple_form form-horizontal" novalidate="novalidate" action="" accept-charset="UTF-8" method="post">
                        <input name="utf8" type="hidden" value="âœ“">
                        <input type="hidden" name="authenticity_token" value="+DxxnKDjlZrXGT7Yafi8zML5r0ry/mH/FXoXxowJovN0MUcebiQUZEK/h+Vwxvo7XZLmnI+k8tc2vORQBpxuwg==">
                        <div class="form-group string required quick_start_login_api_key">
                            <label class="string required col-sm-3 control-label" for="api_key">
                                <abbr title="required">*</abbr> Project API Key</label>
                            <div class="col-sm-9">
                                <input id="api_key" name="api_key" class="string required form-control" type="text" value="">
                            </div>
                        </div>
                        <div class="form-group string required quick_start_login_domain_name">
                            <label class="string required col-sm-3 control-label" for="api_key">
                                <abbr title="required">*</abbr> Domain Name</label>
                            <div class="col-sm-9">
                                <input id="domainName" name="domainName" class="string required form-control" type="text" value="">
                            </div>
                        </div>
                        <div class="form-group string required quick_start_login_api_secret">
                            <label class="string required col-sm-3 control-label" for="call_destination">
                                <abbr title="required">*</abbr> Destination</label>
                            <div class="col-sm-9">
                                <input id="call_destination" name="call_destination" class="string required form-control" type="text" value="">
                            </div>
                        </div>
                        <div class="form-group string required quick_start_login_api_secret">
                            <label class="string required col-sm-3 control-label" for="call_origination">
                                Origination</label>
                            <div class="col-sm-9">
                                <input id="call_origination" name="call_origination" class="string required form-control" type="text" value="">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-offset-3 col-sm-9">
                                 <input type="submit" name="get-callme-btn" value="Enable Call Me" id="get-callme-btn" class="btn btn-success">
                                <input type="submit" name="set-destination-btn" value="Set Destination" id="set-destination-btn" class="btn btn-success">
                                <input type="submit" name="set-origination-btn" value="Set Origination" id="set-origination-btn" class="btn btn-success">
                                <input type="submit" name="get-token-btn" value="Get Tokens" id="get-token-btn" class="btn btn-success">
                            </div>
                        </div>
                    </form>
                </div>
                <div id="callToken" style="display: none;">
                    <hr>
                    <div>
                        <h5><strong>Origination Token  </strong></h5>
                        <p class="h4">
                            <span id="originationToken"></span>
                        </p>
                    </div>
                    <hr>
                    <div>
                        <h5><strong>Destination Token  </strong></h5>
                        <p class="h4">
                            <span id="destinationToken"></span>
                        </p>
                    </div>
                    <hr>
                    <div>
                        <h5><strong>Key Token  </strong></h5>
                        <p class="h4">
                            <span id="keyToken"></span>
                        </p>
                    </div>
                    <hr>
                    <div class="clearfix call-initializer">
                        <button class="btn btn-success pull-left" id="make-anonymous-call-btn">Make anonymous call</button>
                    </div>
                    <hr>
                    <div class="hidden" id="logged-in">
                        <div id="video-container">
                            <div id="incoming-video"></div>
                            <hr>
                        </div>
                        <div id="call-form">
                            <p id="username-calling"></p>
                            <div class="form-group call-terminator hidden">
                                <button class="btn btn-danger" id="initialize-end-btn">End Call</button>
                            </div>
                        </div>
                        <div class="hidden" id="call-connected">
                            <h4>Call Connected</h4>
                            <p id="username-connected"></p>
                            <div class="btn-toolbar">
                                <button class="btn btn-danger" id="end-call-btn">End Call</button>
                                <button class="btn btn-warning" id="hold-call-btn">Hold Call</button>
                                <button class="btn btn-success hidden" id="resume-call-btn">Resume Call</button>
                            </div>
                        </div>
                    </div>
                </div>
                <p id="address-book-entries"></p>
            </div>
        </div>
    </div>

<script>

var callId;

        // Create audio objects to play incoming calls and outgoing calls sound
        var $audioRingIn = $('<audio>', {
            loop: 'loop',
            id: 'ring-in'
        });
        var $audioRingOut = $('<audio>', {
            loop: 'loop',
            id: 'ring-out'
        });

        // Load audio source to DOM to indicate call events
        var audioSource = {
            ringIn: [{
                src: 'https://kandy-portal.s3.amazonaws.com/public/sounds/ringin.mp3',
                type: 'audio/mp3'
            }, {
                src: 'https://kandy-portal.s3.amazonaws.com/public/sounds/ringin.ogg',
                type: 'audio/ogg'
            }],
            ringOut: [{
                src: 'https://kandy-portal.s3.amazonaws.com/public/sounds/ringout.mp3',
                type: 'audio/mp3'
            }, {
                src: 'https://kandy-portal.s3.amazonaws.com/public/sounds/ringout.ogg',
                type: 'audio/ogg'
            }]
        };

        audioSource.ringIn.forEach(function(entry) {
            var $source = $('<source>').attr('src', entry.src);
            $audioRingIn.append($source);
        });

        audioSource.ringOut.forEach(function(entry) {
            var $source = $('<source>').attr('src', entry.src);
            $audioRingOut.append($source);
        });

        $('#callToken').hide();
        var userArray = [];

        /** setup(config) intializes kandy
            @param <object> config
          */
        kandy.setup({
            kandyApiUrl: 'https://api-staging.kandy.io/v1.2',
            remoteVideoContainer: $('#incoming-video')[0],

            // listeners registers events to handlers
            // You can handle all Kandy Events by registering it here
            listeners: {
                callinitiated: onCallInitiate,
                callinitiatefailed: onCallInitiateFail,
                oncall: onCall,
                callended: onCallTerminate,
                callendfailed: onCallEndedFailed
            }
        });

        function setCallMeForDomain(key){
            $.ajax({
                    url: "https://api-staging.kandy.io/v1.2/domains/anonymous/callme?key=" + key,
                    type: 'POST',
                    crossOrigin: true,
                    success: function(result) {
                        if(result){
                          /*  for(var i in result){
                                console.log(result[i].origination);
                                setOrigination(key, result.origination);
                            }*/
                        }
                    
                    },
                    error: function(errorMsg) {
                        console.log("Error in setting call me:" + errorMsg);
                    }
            });
        }
        function setOrigination(key, origination) {
            $.ajax({
                url: "https://api-staging.kandy.io/v1.2/domains/anonymous/origination?key=" + key + "&origination=" + origination,
                type: 'POST',
                crossOrigin: true,
                success: function(result) {
                    console.log("Successfully set origination for the api key");
                },
                error: function(errorMsg) {
                    console.log("Error in setting origination:" + errorMsg);
                }
            });
        }

        function whiteListDestination(key, destination) {

            $.ajax({
                url: "https://api-staging.kandy.io/v1.2/domains/anonymous/destination?key=" + key + "&destination=" + destination,
                type: 'POST',
                crossOrigin: true,
                success: function(result) {
                    console.log("result", result);
                    console.log("Successfully set destination for the api key");
                },
                error: function(errorMsg) {
                    console.log("Error in setting destination:" + JSON.stringify(errorMsg));
                }
            });
        }

        function getAnonymousToken(key, destination, origination) {
            console.log("getAnonymousToken key:"+key+"destination:"+destination+"origination:"+origination);
            $.ajax({
                url: "https://api-staging.kandy.io/v1.2/domains/anonymous/tokens",
                crossOrigin: true,
                data: {
                    key: key,
                    destination: destination,
                    origination: origination
                },
                success: function(result) {

                    if (result) {
                        
                        for (var token in result) {
                               console.log("result[token]:"+JSON.stringify(result[token]));
                            $('#originationToken').text(result[token].origination_token);
                            $('#destinationToken').text(result[token].destination_token);
                            $('#keyToken').text(result[token].account_token);
                        }

                        $('#callToken').show();
                    }

                },
                error: function(errorMsg) {
                    console.log("Error in getting anonymous tokens:" + errorMsg);
                }
            });
        }


        $('#get-callme-btn').on('click', function(e) {
            e.preventDefault();
            var apiKey = $("#api_key").val()
            setCallMeForDomain(apiKey);
        });
        $('#set-origination-btn').on('click', function(e) {
            e.preventDefault();
            var apiKey = $("#api_key").val()
            var callOrigination = $('#call_origination').val();
            setOrigination(apiKey, callOrigination);
        });

        $('#set-destination-btn').on('click', function(e) {
            e.preventDefault();
            var apiKey = $("#api_key").val()
            var callDestination = $('#call_destination').val();
            whiteListDestination(apiKey, callDestination);
        });

        $('#get-token-btn').on('click', function(e) {
            e.preventDefault();
            var apiKey = $("#api_key").val()
            var callDestination = $('#call_destination').val();
            var callOrigination = $('#call_origination').val();
            console.log("apiKey:"+apiKey+"callDestination:"+callDestination+"callOrigination:"+callOrigination);
            getAnonymousToken(apiKey, callDestination, callOrigination);
        });

        $('#make-anonymous-call-btn').on('click', function(e) {
            e.preventDefault();
            var apiKey = $("#api_key").val()
            var destinationToken = $('#destinationToken').text();
            var originationToken = $('#originationToken').text();
            var keyToken = $('#keyToken').text();
            var domainname = $('#domainName').val();
            var timestamp1=new Date().getTime();
            //var accountToken="robinsummers@testnewdomain.gmail.com"+";"+timestamp1;
            //'AAT5671a3659d5141789c46e4388e5ea97d';
            // 
            //
            //
           // kandy.call.makeCall("andrewpeters@stagingtestproject.gmail.com", true);
            console.log("apiKey:"+apiKey+"   keyToken:"+keyToken+"  originationToken:"+originationToken+" destinationToken:"+destinationToken);
           //kandy.call.makeAnonymousCallWithToken(apiKey,"",keyToken,originationToken,destinationToken, true);
          // kandy.call.makeAnonymousCall(apiKey,destinationToken, "", originationToken, true );
          kandy.call.makeAnonymousCallWithToken(apiKey,domainname,keyToken,originationToken,destinationToken, true); 
        });

        /** UIState is a custom piece of code that shuffles between UI states
          eg:: If user is authenticated, the relevant DOM elements are brought to screen
          and the rest are hidden. Using this method is NOT recommended!
      */

        var username, UIState = {};

        /*UIState.authenticated = function() {
            $('#login-form').addClass('hidden');
            $('#logged-in').removeClass('hidden');
            $('.username').text(username);
        };

        UIState.unauthenticated = function() {
            $('#login-form').removeClass('hidden');
            $('#logged-in').addClass('hidden');
            $('.username').text('');
        };*/

        UIState.initial = function() {
            console.log('initial');

            $audioRingIn[0].pause();
            $audioRingOut[0].pause();

            $('#call-form p, #call-connected p').text('');
            $('#call-connected, .call-terminator, #resume-call-btn').addClass('hidden');
            $('#call-form, .call-initializer').removeClass('hidden')
        };
        // Event handler for callinitiate
        function onCallInitiate(call) {
            callId = call.getId();
            $audioRingIn[0].pause();
            $audioRingOut[0].play();

            $('#username-calling').text('Calling ' + $('#originationToken').text());
            UIState.callinitialized();
        }

        // Event handler for callinitiatefail event
        function onCallInitiateFail() {
            console.debug('call initiate fail');

            $audioRingOut[0].pause();
            UIState.initial();
            alert('call failed');
        }

        UIState.callinitialized = function() {
            console.log('callinitialized');

            $('.call-initializer').addClass('hidden');
        };

        // Event handler for oncall event
        function onCall(call) {
            console.debug('oncall');
            $audioRingOut[0].pause();
            UIState.oncall();
        }

        // Event handler for callended event
        function onCallTerminate(call) {
            console.debug('callended');
            callId = null;

            $audioRingOut[0].play();
            $audioRingIn[0].pause();

            UIState.initial();
        }

        // Event handler for callendedfailed event
        function onCallEndedFailed() {
            console.debug('callendfailed');
            callId = null;
        }

        $('#hold-call-btn').on('click', function() {
            kandy.call.holdCall(callId);
            UIState.holdcall();
        });

        $('#resume-call-btn').on('click', function() {
            kandy.call.unHoldCall(callId);
            UIState.resumecall();
        });

        // Event handler for call end button
        $('#end-call-btn').on('click', function() {
            kandy.call.endCall(callId);
            UIState.initial();
        });

        UIState.oncall = function() {
            console.log('oncall');

            $('#call-form').addClass('hidden');
            $('#call-connected').removeClass('hidden');
        };

        UIState.holdcall = function() {
            console.log('holdcall');

            $('#hold-call-btn').addClass('hidden');
            $('#resume-call-btn').removeClass('hidden');
        };

        UIState.resumecall = function() {
            console.log('resumecall');

            $('#hold-call-btn').removeClass('hidden');
            $('#resume-call-btn').addClass('hidden');
        };

    </script>


</body></html>